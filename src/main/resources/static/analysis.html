<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶•ì˜ê¸ˆ ê´€ë¦¬ ì‹œìŠ¤í…œ - ë‚˜ì˜ ë¶„ì„</title>

    <!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 16.66%;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .sidebar-btn {
            padding: 18px 20px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .sidebar-btn:hover {
            background: #667eea;
            color: white;
            transform: translateX(5px);
        }

        .sidebar-btn.active {
            background: #667eea;
            color: white;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .auth-btn {
            padding: 10px 24px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-btn:hover {
            background: white;
            color: #667eea;
        }

        .dashboard {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .dashboard-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            margin-bottom: 30px;
        }

        .card-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
        }

        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 12px 30px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px 10px 0 0;
            font-size: 15px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-box.primary {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
        }

        .stat-box.success {
            background: linear-gradient(135deg, #55efc4 0%, #00b894 100%);
        }

        .stat-box.warning {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
        }

        .stat-box.danger {
            background: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
        }

        .stat-box.info {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        }

        .stat-label {
            font-size: 14px;
            font-weight: 600;
            color: #555;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-detail {
            font-size: 12px;
            color: #666;
        }

        .list-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .list-item {
            background: white;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .list-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .list-item-info {
            flex: 1;
        }

        .list-item-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .list-item-detail {
            font-size: 13px;
            color: #666;
        }

        .list-item-value {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
        }

        .chart-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            height: 400px;
            min-height: 400px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
        }

        .loading {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 50px;
        }

        .error-message {
            color: #ff4757;
            text-align: center;
            padding: 20px;
            font-size: 16px;
        }

        .no-data {
            text-align: center;
            color: #999;
            padding: 40px;
            font-size: 16px;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-danger {
            background: #ff7675;
            color: white;
        }

        .badge-warning {
            background: #fdcb6e;
            color: #333;
        }

        .badge-success {
            background: #00b894;
            color: white;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="sidebar">
        <button class="sidebar-btn active" onclick="goToPage('analysis.html')">ë¶„ì„ ë° í†µê³„</button>
        <button class="sidebar-btn" onclick="goToPage('eventregister.html')">ì´ë²¤íŠ¸ ë“±ë¡</button>
        <button class="sidebar-btn" onclick="goToPage('event.html')">ì´ë²¤íŠ¸ ì¡°íšŒ</button>
    </div>

    <div class="main-content">
        <div class="header">
            <div class="logo">ì¶•ì˜ê¸ˆ ê´€ë¦¬ ì‹œìŠ¤í…œ</div>
            <div class="auth-buttons" id="authButtons"></div>
        </div>

        <div class="dashboard">
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">ë‚˜ì˜ ì¶•ì˜ê¸ˆ ë¶„ì„</div>
                    <div class="tab-navigation">
                        <button class="tab-btn active" onclick="changeTab('dashboard')">ğŸ“Š ì¢…í•© ëŒ€ì‹œë³´ë“œ</button>
                        <button class="tab-btn" onclick="changeTab('pattern')">ğŸ“ˆ ì§€ì¶œ íŒ¨í„´</button>
                        <button class="tab-btn" onclick="changeTab('relation')">ğŸ‘¥ ì§€ì¸ ë¶„ì„</button>
                        <button class="tab-btn" onclick="changeTab('recovery')">ğŸ’° íšŒìˆ˜ìœ¨</button>
                    </div>
                </div>

                <!-- íƒ­ 1: ì¢…í•© ëŒ€ì‹œë³´ë“œ -->
                <div id="tab-dashboard" class="tab-content active">
                    <div class="stats-grid">
                        <div class="stat-box primary">
                            <div class="stat-label">ì´ ì¤€ ê¸ˆì•¡</div>
                            <div class="stat-value" id="totalGive">0ì›</div>
                        </div>
                        <div class="stat-box success">
                            <div class="stat-label">ì´ ë°›ì€ ê¸ˆì•¡</div>
                            <div class="stat-value" id="totalTake">0ì›</div>
                        </div>
                        <div class="stat-box warning">
                            <div class="stat-label">ì”ì•¡</div>
                            <div class="stat-value" id="balance">0ì›</div>
                        </div>
                        <div class="stat-box info">
                            <div class="stat-label">íšŒìˆ˜ìœ¨</div>
                            <div class="stat-value" id="recoveryRate">0%</div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">ì „ë…„ ëŒ€ë¹„ ë³€í™”</div>
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-label">ì „ë…„ ëŒ€ë¹„ ì§€ì¶œ</div>
                                <div class="stat-value" id="yearChange">-</div>
                                <div class="stat-detail" id="yearChangeDetail">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">ìµœê·¼ ì´ë²¤íŠ¸</div>
                        <div class="list-container" id="recentEvents">
                            <div class="loading-container">
                                <div class="loading"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- íƒ­ 2: ì§€ì¶œ íŒ¨í„´ ë¶„ì„ -->
                <div id="tab-pattern" class="tab-content">
                    <div class="section">
                        <div class="section-title">
                            ì›”ë³„ ì§€ì¶œ ê·¸ë˜í”„
                            <select id="yearSelector" onchange="changeYear()" style="float: right; padding: 8px 15px; border-radius: 8px; border: 2px solid #667eea; font-size: 14px; cursor: pointer;"></select>
                        </div>
                        <div class="chart-container" id="monthlyChart">
                            <div class="loading-container">
                                <div class="loading"></div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">ìš”ì¼ë³„ ì§€ì¶œ ê·¸ë˜í”„</div>
                        <div class="chart-container" id="weekdayChart">
                            <div class="loading-container">
                                <div class="loading"></div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">ì´ë²¤íŠ¸ë³„ ë¶„í¬</div>
                        <div class="stats-grid" id="eventDistribution">
                            <div class="loading-container">
                                <div class="loading"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- íƒ­ 3: ì§€ì¸ ë¶„ì„ -->
                <div id="tab-relation" class="tab-content">
                    <div class="section">
                        <div class="section-title">TOP 5 ì§€ì¸</div>
                        <div class="list-container" id="topRelations">
                            <div class="loading-container">
                                <div class="loading"></div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">ì§€ì¸ë³„ íšŒìˆ˜ìœ¨</div>
                        <div class="list-container" id="relationRecovery">
                            <div class="loading-container">
                                <div class="loading"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- íƒ­ 4: íšŒìˆ˜ìœ¨ ëŒ€ì‹œë³´ë“œ -->
                <div id="tab-recovery" class="tab-content">
                    <div class="stats-grid">
                        <div class="stat-box success">
                            <div class="stat-label">ì „ì²´ íšŒìˆ˜ìœ¨</div>
                            <div class="stat-value" id="totalRecovery">0%</div>
                        </div>
                        <div class="stat-box danger">
                            <div class="stat-label">ì”ì•¡</div>
                            <div class="stat-value" id="recoveryBalance">0ì›</div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">ë¯¸íšŒìˆ˜ ì§€ì¸ ë¦¬ìŠ¤íŠ¸</div>
                        <div class="list-container" id="unrecoveredList">
                            <div class="loading-container">
                                <div class="loading"></div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">ì¥ê¸° ë¯¸íšŒìˆ˜ ê²½ê³  (180ì¼ ì´ìƒ)</div>
                        <div class="list-container" id="longTermWarning">
                            <div class="loading-container">
                                <div class="loading"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="/assets/js/auth.js"></script>
<script>
    const API_BASE_URL = 'http://localhost:8080';
    let currentTab = 'dashboard';
    let selectedYear = new Date().getFullYear();

    window.onload = function() {
        checkLoginStatus();
        loadDashboardData();
        initYearSelector();
    };

    function initYearSelector() {
        const selector = document.getElementById('yearSelector');
        const currentYear = new Date().getFullYear();
        for (let i = 0; i < 5; i++) {
            const year = currentYear - i;
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year + 'ë…„';
            if (year === currentYear) {
                option.selected = true;
            }
            selector.appendChild(option);
        }
    }

    function changeYear() {
        const selector = document.getElementById('yearSelector');
        selectedYear = parseInt(selector.value);
        loadPatternData();
    }

    function checkLoginStatus() {
        const token = sessionStorage.getItem('authToken');
        console.log('sending token', token);


        const authButtons = document.getElementById('authButtons');
        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.');
            window.location.href = 'login.html';
            return;
        }
        authButtons.innerHTML = '<button class="auth-btn" onclick="jwtLogout()">ë¡œê·¸ì•„ì›ƒ</button>';
    }

    function changeTab(tabName) {
        currentTab = tabName;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`tab-${tabName}`).classList.add('active');
        loadTabData(tabName);
    }

    function loadTabData(tabName) {
        switch(tabName) {
            case 'dashboard':
                loadDashboardData();
                break;
            case 'pattern':
                loadPatternData();
                break;
            case 'relation':
                loadRelationData();
                break;
            case 'recovery':
                loadRecoveryData();
                break;
        }
    }

    async function loadDashboardData() {
        const token = sessionStorage.getItem('authToken');
        try {
            const dashboardResponse = await fetch(`${API_BASE_URL}/analysis/dashboard`, {
                headers: { 'X-AUTH-TOKEN': token }
            });
            if (!dashboardResponse.ok) throw new Error('Failed to fetch dashboard data');
            const dashboardData = await dashboardResponse.json();

            document.getElementById('totalGive').textContent = dashboardData.totalGive.toLocaleString() + 'ì›';
            document.getElementById('totalTake').textContent = dashboardData.totalTake.toLocaleString() + 'ì›';
            document.getElementById('balance').textContent = dashboardData.balance.toLocaleString() + 'ì›';
            document.getElementById('recoveryRate').textContent = dashboardData.recoveryRate + '%';

            const changePercent = dashboardData.yearChangePercent > 0 ? '+' + dashboardData.yearChangePercent : dashboardData.yearChangePercent;
            document.getElementById('yearChange').textContent = changePercent + '%';
            document.getElementById('yearChangeDetail').textContent = dashboardData.yearChangeAmount.toLocaleString() + 'ì›';

            const eventsResponse = await fetch(`${API_BASE_URL}/analysis/recent-events`, {
                headers: { 'X-AUTH-TOKEN': token }
            });
            if (eventsResponse.ok) {
                const events = await eventsResponse.json();
                displayRecentEvents(events);
            } else {
                document.getElementById('recentEvents').innerHTML = '<div class="no-data">ìµœê·¼ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        } catch (error) {
            console.error('Error loading dashboard:', error);
            displayErrorMessage();
        }
    }

    function displayErrorMessage() {
        document.getElementById('totalGive').textContent = 'ì˜¤ë¥˜';
        document.getElementById('totalTake').textContent = 'ì˜¤ë¥˜';
        document.getElementById('balance').textContent = 'ì˜¤ë¥˜';
        document.getElementById('recoveryRate').textContent = 'ì˜¤ë¥˜';
        document.getElementById('yearChange').textContent = 'ì˜¤ë¥˜';
        document.getElementById('yearChangeDetail').textContent = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
        document.getElementById('recentEvents').innerHTML = '<div class="error-message">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
    }

    function displayRecentEvents(events) {
        const container = document.getElementById('recentEvents');
        if (!events || events.length === 0) {
            container.innerHTML = '<div class="no-data">ìµœê·¼ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }
        let html = '';
        events.forEach(event => {
            const typeText = event.actionType === 'GIVE' ? 'ì§€ì¶œ' : 'ìˆ˜ì…';
            const typeColor = event.actionType === 'GIVE' ? '#ff7675' : '#00b894';
            const eventTypeName = getEventTypeName(event.eventType);
            html += `
                <div class="list-item">
                    <div class="list-item-info">
                        <div class="list-item-name">${event.acquaintanceName}</div>
                        <div class="list-item-detail">${eventTypeName} Â· ${event.eventDate} Â· ${typeText}</div>
                    </div>
                    <div class="list-item-value" style="color: ${typeColor}">${event.amount.toLocaleString()}ì›</div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function getEventTypeName(eventType) {
        const names = { 'WEDDING': 'ê²°í˜¼ì‹', 'FUNERAL': 'ì¥ë¡€ì‹', 'BIRTHDAY': 'ìƒì¼', 'ETC': 'ê¸°íƒ€' };
        return names[eventType] || eventType;
    }

    async function loadPatternData() {
        const token = sessionStorage.getItem('authToken');
        try {
            const response = await fetch(`${API_BASE_URL}/analysis/pattern?year=${selectedYear}`, {
                headers: { 'X-AUTH-TOKEN': token }
            });
            if (!response.ok) throw new Error('Failed to fetch pattern data');
            const data = await response.json();
            drawMonthlyChart(data.monthlyData);
            drawWeekdayChart(data.weekdayData);
            displayEventDistribution(data.eventTypeData);
        } catch (error) {
            console.error('Error loading pattern:', error);
            displayPatternError();
        }
    }

    function drawMonthlyChart(monthlyData) {
        const ctx = document.getElementById('monthlyChart');
        if (window.monthlyChartInstance) window.monthlyChartInstance.destroy();
        ctx.innerHTML = `<div class="chart-title">ì›”ë³„ ì§€ì¶œ ì¶”ì´ (${selectedYear}ë…„)</div><canvas id="monthlyCanvas" style="max-height: 350px;"></canvas>`;
        const canvas = document.getElementById('monthlyCanvas');
        const months = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
        const amounts = [];
        for (let i = 1; i <= 12; i++) amounts.push(monthlyData[i] || 0);

        window.monthlyChartInstance = new Chart(canvas, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'ì§€ì¶œ ê¸ˆì•¡',
                    data: amounts,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'ì§€ì¶œ: ' + context.parsed.y.toLocaleString() + 'ì›';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + 'ì›';
                            }
                        }
                    }
                }
            }
        });
    }

    function drawWeekdayChart(weekdayData) {
        const ctx = document.getElementById('weekdayChart');
        if (window.weekdayChartInstance) window.weekdayChartInstance.destroy();
        ctx.innerHTML = '<div class="chart-title">ìš”ì¼ë³„ í‰ê·  ì§€ì¶œ</div><canvas id="weekdayCanvas" style="max-height: 350px;"></canvas>';
        const canvas = document.getElementById('weekdayCanvas');
        const days = ['ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼', 'ì¼ìš”ì¼'];
        const amounts = days.map(day => weekdayData[day] || 0);

        window.weekdayChartInstance = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: days,
                datasets: [{
                    label: 'í‰ê·  ì§€ì¶œ',
                    data: amounts,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)', 'rgba(199, 199, 199, 0.7)'
                    ],
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'í‰ê· : ' + context.parsed.y.toLocaleString() + 'ì›';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + 'ì›';
                            }
                        }
                    }
                }
            }
        });
    }

    function displayEventDistribution(eventTypeData) {
        const container = document.getElementById('eventDistribution');
        const eventTypes = {
            'WEDDING': { name: 'ê²°í˜¼ì‹', icon: 'ğŸ’’' },
            'FUNERAL': { name: 'ì¥ë¡€ì‹', icon: 'ğŸ•¯ï¸' },
            'BIRTHDAY': { name: 'ìƒì¼', icon: 'ğŸ‚' },
            'ETC': { name: 'ê¸°íƒ€', icon: 'ğŸ' }
        };
        let html = '';
        for (const [type, info] of Object.entries(eventTypes)) {
            const data = eventTypeData[type];
            const count = data ? data.count : 0;
            const amount = data ? data.amount : 0;
            html += `
                <div class="stat-box">
                    <div class="stat-label">${info.icon} ${info.name}</div>
                    <div class="stat-value">${count}ê±´</div>
                    <div class="stat-detail">${amount.toLocaleString()}ì›</div>
                </div>
            `;
        }
        container.innerHTML = html;
    }

    function displayPatternError() {
        document.getElementById('monthlyChart').innerHTML = '<div class="error-message">ì›”ë³„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        document.getElementById('weekdayChart').innerHTML = '<div class="error-message">ìš”ì¼ë³„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        document.getElementById('eventDistribution').innerHTML = '<div class="error-message">ì´ë²¤íŠ¸ ë¶„í¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    async function loadRelationData() {
        const token = sessionStorage.getItem('authToken');
        try {
            const response = await fetch(`${API_BASE_URL}/analysis/relation`, {
                headers: { 'X-AUTH-TOKEN': token }
            });
            if (!response.ok) throw new Error('Failed to fetch relation data');
            const data = await response.json();
            displayTopRelations(data.topRelations);
            displayRelationRecovery(data.relationRecovery);
        } catch (error) {
            console.error('Error loading relation:', error);
            displayRelationError();
        }
    }

    function displayTopRelations(topRelations) {
        const container = document.getElementById('topRelations');
        if (!topRelations || topRelations.length === 0) {
            container.innerHTML = '<div class="no-data">ì§€ì¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }
        let html = '';
        topRelations.forEach((rel, index) => {
            html += `
                <div class="list-item">
                    <div class="list-item-info">
                        <div class="list-item-name">${index + 1}. ${rel.name}</div>
                        <div class="list-item-detail">${rel.eventCount}ê±´ Â· í‰ê·  ${rel.avgAmount.toLocaleString()}ì›</div>
                    </div>
                    <div class="list-item-value">${rel.totalAmount.toLocaleString()}ì›</div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function displayRelationRecovery(relationRecovery) {
        const container = document.getElementById('relationRecovery');
        if (!relationRecovery || relationRecovery.length === 0) {
            container.innerHTML = '<div class="no-data">íšŒìˆ˜ìœ¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }
        let html = '';
        relationRecovery.forEach(rel => {
            const badgeClass = rel.rate >= 80 ? 'badge-success' : rel.rate >= 50 ? 'badge-warning' : 'badge-danger';
            html += `
                <div class="list-item">
                    <div class="list-item-info">
                        <div class="list-item-name">${rel.name} <span class="badge ${badgeClass}">${rel.rate}%</span></div>
                        <div class="list-item-detail">ì¤€ ê¸ˆì•¡: ${rel.give.toLocaleString()}ì› / ë°›ì€ ê¸ˆì•¡: ${rel.take.toLocaleString()}ì›</div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function displayRelationError() {
        document.getElementById('topRelations').innerHTML = '<div class="error-message">TOP 5 ì§€ì¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        document.getElementById('relationRecovery').innerHTML = '<div class="error-message">íšŒìˆ˜ìœ¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    async function loadRecoveryData() {
        const token = sessionStorage.getItem('authToken');
        try {
            const response = await fetch(`${API_BASE_URL}/analysis/recovery`, {
                headers: { 'X-AUTH-TOKEN': token }
            });
            if (!response.ok) throw new Error('Failed to fetch recovery data');
            const data = await response.json();
            displayRecoveryStats(data);
            displayUnrecoveredList(data.unrecoveredList);
            displayLongTermWarning(data.longTermWarning);
        } catch (error) {
            console.error('Error loading recovery:', error);
            displayRecoveryError();
        }
    }

    function displayRecoveryStats(data) {
        document.getElementById('totalRecovery').textContent = data.totalRecovery + '%';

        const balanceElement = document.getElementById('recoveryBalance');
        const balance = data.unrecovered;  // ë°±ì—”ë“œì—ì„œ unrecoveredë¡œ ì˜´

        if (balance >= 0) {
            // í”ŒëŸ¬ìŠ¤ë©´ ë¹¨ê°„ìƒ‰ (ì†í•´ - ëª» ë°›ì€ ëˆ)
            balanceElement.textContent = '-' + balance.toLocaleString() + 'ì›';
            balanceElement.style.color = '#d63031';
        } else {
            // ë§ˆì´ë„ˆìŠ¤ë©´ ì´ˆë¡ìƒ‰ (ì´ë“ - ë” ë°›ì€ ëˆ)
            balanceElement.textContent = '+' + Math.abs(balance).toLocaleString() + 'ì›';
            balanceElement.style.color = '#00b894';
        }
    }

    function displayUnrecoveredList(unrecoveredList) {
        const container = document.getElementById('unrecoveredList');
        if (!unrecoveredList || unrecoveredList.length === 0) {
            container.innerHTML = '<div class="no-data">ë¯¸íšŒìˆ˜ ì§€ì¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }
        let html = '';
        unrecoveredList.forEach(rel => {
            const badgeClass = rel.days >= 180 ? 'badge-danger' : rel.days >= 90 ? 'badge-warning' : '';
            html += `
                <div class="list-item">
                    <div class="list-item-info">
                        <div class="list-item-name">${rel.name} ${badgeClass ? `<span class="badge ${badgeClass}">${rel.days}ì¼ ê²½ê³¼</span>` : ''}</div>
                        <div class="list-item-detail">${rel.date} ì§€ì¶œ</div>
                    </div>
                    <div class="list-item-value">${rel.amount.toLocaleString()}ì›</div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function displayLongTermWarning(longTermList) {
        const container = document.getElementById('longTermWarning');
        if (!longTermList || longTermList.length === 0) {
            container.innerHTML = '<div class="no-data">ì¥ê¸° ë¯¸íšŒìˆ˜ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }
        let html = '';
        longTermList.forEach(rel => {
            html += `
                <div class="list-item">
                    <div class="list-item-info">
                        <div class="list-item-name">${rel.name} <span class="badge badge-danger">ê²½ê³ </span></div>
                        <div class="list-item-detail">${rel.days}ì¼ ë™ì•ˆ ë¯¸íšŒìˆ˜ (${rel.date})</div>
                    </div>
                    <div class="list-item-value">${rel.amount.toLocaleString()}ì›</div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function displayRecoveryError() {
        document.getElementById('totalRecovery').textContent = 'ì˜¤ë¥˜';
        document.getElementById('unrecovered').textContent = 'ì˜¤ë¥˜';
        document.getElementById('unrecoveredList').innerHTML = '<div class="error-message">ë¯¸íšŒìˆ˜ ì§€ì¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        document.getElementById('longTermWarning').innerHTML = '<div class="error-message">ì¥ê¸° ë¯¸íšŒìˆ˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    function goToPage(page) {
        window.location.href = page;
    }
</script>
</body>
</html>